rm(list=ls())

#This code peforms two main tasks:

#ONE: ranks area of occupancies (AOOs) in order of size (1=smallest, 129=largest) for each of the 7 range size metrics used to estimate AOOs, and for the AOOs based on the 
#NatureServe maps (downloaded from http://www.natureserve.org/conservation-tools/data-maps-tools/digital-distribution-native-us-fishes-watershed)
#For each of the 8 sets of AOO rankings (for the 7 range metrics plus NatureServe), the code then scales the values between 0 and 1
#It then calculates mean and standard deviations for the ranks across the 7 range metrics for each species. 
#It then calculates logarithms(base 10) of AOOs for all 7 range metrics AND AOO based on NatureServe maps (downloaded from http://www.natureserve.org/conservation-tools/data-maps-tools/digital-distribution-native-us-fishes-watershed)
#Sections of code performing the tasks above are labeled 1a through 1j

#TWO: calculates Relative Climate Sensitivity index (RCS) for each species (for both HUC and buffer scale. Can be modified to calculate RCS for other AOO scales)
#Sections of code performing the tasks above are labeled 2a through 2i

#All data is merged into a dataframe and exported as a .csv 
#Code written by J A Smith (contact=jennifer.smith@utsa.edu) on 10/22/2018


install.packages("scales")
library("scales")

#PART ONE: AOO calculations

#1a Import AOO data (this data is the output at lines 317, 366, 597, 601, 605, 609, 
#and 651 in R script 'GBIF data filtering and AOO estimation_11_13_2018') 

Buffer_1km <- read.csv(file="C:\\Users\\rrd600\\OneDrive - University of Texas at San Antonio\\Mims\\AOOData\\Buffer1km_AllSpecies.csv")
Buffer_5km <- read.csv(file="C:\\Users\\rrd600\\OneDrive - University of Texas at San Antonio\\Mims\\AOOData\\Buffer5km_AllSpecies.csv")
Buffer_10km <- read.csv(file="C:\\Users\\rrd600\\OneDrive - University of Texas at San Antonio\\Mims\\AOOData\\Buffer10km_AllSpecies.csv")
Buffer_20km <- read.csv(file="C:\\Users\\rrd600\\OneDrive - University of Texas at San Antonio\\Mims\\AOOData\\Buffer20km_AllSpecies.csv")
HUC12 <- read.csv(file="C:\\Users\\rrd600\\OneDrive - University of Texas at San Antonio\\Mims\\AOOData\\HUC12_AllSpecies.csv")
HUC8 <- read.csv(file="C:\\Users\\rrd600\\OneDrive - University of Texas at San Antonio\\Mims\\AOOData\\HUC8_AllSpecies.csv")
MCP <- read.csv(file="C:\\Users\\rrd600\\OneDrive - University of Texas at San Antonio\\Mims\\AOOData\\MCP_AllSpecies.csv")
NatureServe <- read.csv(file="C:\\Users\\rrd600\\OneDrive - University of Texas at San Antonio\\Mims\\AOOData\\nature serve area.csv")

#1b. Renames column headings in MCP and NatureServe dataframes

names(MCP)[3]<-"total_area_MCP"
names(NatureServe)[2] <-"total_area_NatureServe"

#1c. Adds columns to each AOO dataframe and stores ranks (rank from 1 to 129 with 1 being the smallest area of occupancy)

Buffer_1km$rank1km <- rank(Buffer_1km$total_area_1km)
Buffer_5km$rank5km <- rank(Buffer_5km$total_area_5km)
Buffer_10km$rank10km <- rank(Buffer_10km$total_area_10km)
Buffer_20km$rank20km <- rank(Buffer_20km$total_area_20km)
HUC12$rankHUC12 <- rank(HUC12$total_area_huc12)
HUC8$rankHUC8 <- rank(HUC8$total_area_huc8)
MCP$RankMCP <- rank(MCP$total_area_MCP)
NatureServe$RankNatureServe <- rank(NatureServe$total_area_NatureServe)

#1d. Merges the 7 dataframes for the 7 metrics and removes duplicate columns (e.g., species names)

MergedAOO<- cbind(Buffer_1km,Buffer_5km,Buffer_10km, Buffer_20km, HUC8, HUC12, MCP, NatureServe)

All_AOO <- MergedAOO[-c(5,6,9,10,13,14,17,18,21,22,25,26,29)]

#1e. Creates columns for mean and standard deviation values of ranks to be stored. Means and standard deviations consider values for AOO for the 7 range metrics (do not include ranks for NatureServe)

All_AOO$mean_Rank <-NA
All_AOO$sd_Rank <- NA

#1f. Loop to calculate and store mean of the 7 ranks in the mean column

for(i in 1:nrow(All_AOO)){
  All_AOO[i,]$mean_Rank <- mean(c(All_AOO[i,]$rank1km,  All_AOO[i,]$rank5km,  All_AOO[i,]$rank10km, All_AOO[i,]$rank20km, All_AOO[i,]$rankHUC8, All_AOO[i,]$rankHUC12, All_AOO[i,]$RankMCP ), na.rm=TRUE)
}

#1g. loop to calculate and store standard deviation of the 7 ranks in the sd column


for(i in 1:nrow(All_AOO)){
  All_AOO[i,]$sd_Rank <- sd(c(All_AOO[i,]$rank1km,  All_AOO[i,]$rank5km,  All_AOO[i,]$rank10km, All_AOO[i,]$rank20km, All_AOO[i,]$rankHUC8, All_AOO[i,]$rankHUC12, All_AOO[i,]$RankMCP), na.rm=TRUE)
}

#1h. Scales mean rank between 0 and 1

All_AOO$StandardizedMean <- rescale(All_AOO$mean_Rank, to =c(0,1))


#1i. Calculates and stores coefficient of variation (cv) for the rankings in a new column entitled 'cv'

All_AOO$cv <- (All_AOO$sd_Rank/All_AOO$mean_Rank)*100


#1j. calculates and stores logarithms (base 10) of AOOs for all 7 range metrics

All_AOO$logBuffer1km <- log10(All_AOO$total_area_1km)
All_AOO$logBuffer5km <- log10(All_AOO$total_area_5km)
All_AOO$logBuffer100km <- log10(All_AOO$total_area_10km)
All_AOO$logBuffer20km <- log10(All_AOO$total_area_20km)
All_AOO$logHUC8 <- log10(All_AOO$total_area_huc8)
All_AOO$logHUC12 <- log10(All_AOO$total_area_huc12)
All_AOO$logMCP <- log10(All_AOO$total_area_MCP)
All_AOO$logNatureServe <- log10(All_AOO$total_area_NatureServe)


write.csv(All_AOO,"C:\\Users\\rrd600\\Desktop\\All_AOO.csv")

############################PART TWO - RCS index

########For HUC 8#######################

#2a. Imports standard deviations for climatic data that indicate climate breath for each species at the HUC8 level

StandardDevs_HUC8 <- read.csv(file="C:\\Users\\rrd600\\OneDrive - University of Texas at San Antonio\\Mims\\AOOData\\complete_sd_HUC8.csv")


#2b. Scales standard deviations for each climatic variable (n=6) between 0 and 1

StandardDevs_HUC8$SD_TMax_Scale <- ((StandardDevs_HUC8$matrix_sdtmax - min(StandardDevs_HUC8$matrix_sdtmax))/(max(StandardDevs_HUC8$matrix_sdtmax, na.rm=TRUE) - min(StandardDevs_HUC8$matrix_sdtmax, na.rm=TRUE))) #for Tmax
StandardDevs_HUC8$SD_ppt_Scale <- ((StandardDevs_HUC8$matrix_sdppt - min(StandardDevs_HUC8$matrix_sdppt))/(max(StandardDevs_HUC8$matrix_sdppt, na.rm=TRUE) - min(StandardDevs_HUC8$matrix_sdppt, na.rm=TRUE))) 
StandardDevs_HUC8$SD_TMaxAug_Scale <- ((StandardDevs_HUC8$matrix_sdtmaxaug - min(StandardDevs_HUC8$matrix_sdtmaxaug))/(max(StandardDevs_HUC8$matrix_sdtmaxaug, na.rm=TRUE) - min(StandardDevs_HUC8$matrix_sdtmaxaug, na.rm=TRUE))) 
StandardDevs_HUC8$SD_TMin_Scale <- ((StandardDevs_HUC8$matrix_sdtmin - min(StandardDevs_HUC8$matrix_sdtmin))/(max(StandardDevs_HUC8$matrix_sdtmin, na.rm=TRUE) - min(StandardDevs_HUC8$matrix_sdtmin, na.rm=TRUE))) 
StandardDevs_HUC8$SD_TMinJan_Scale <- ((StandardDevs_HUC8$matrix_sdtminjan - min(StandardDevs_HUC8$matrix_sdtminjan))/(max(StandardDevs_HUC8$matrix_sdtminjan, na.rm=TRUE) - min(StandardDevs_HUC8$matrix_sdtminjan, na.rm=TRUE))) 
StandardDevs_HUC8$SD_TMean_Scale <- ((StandardDevs_HUC8$matrix_sdtmean - min(StandardDevs_HUC8$matrix_sdtmean))/(max(StandardDevs_HUC8$matrix_sdtmean, na.rm=TRUE) - min(StandardDevs_HUC8$matrix_sdtmean, na.rm=TRUE))) 

#2c. Calculates the mean of the 6 scaled standard deviations to derive a mean relative climate breadth for each species
StandardDevs_HUC8$CS <- ((StandardDevs_HUC8$SD_TMax_Scale + StandardDevs_HUC8$SD_ppt_Scale + StandardDevs_HUC8$SD_TMaxAug_Scale + StandardDevs_HUC8$SD_TMin_Scale + StandardDevs_HUC8$SD_TMinJan_Scale + StandardDevs_HUC8$SD_TMean_Scale )/6)


#2d. Rename columns in AOO dataframe and relative climate breadth dataframe so that they match, and thus that the tables can be merged

names(All_AOO)[2]<-"Species"
names(StandardDevs_HUC8)[1] <-"Species"

#2e. Merge AOO dataframe and relative climate breadth dataframe

RCS_Data_HUC8 <- merge(All_AOO,StandardDevs_HUC8, by.x="Species")


#2f. Scales AOOs defined by HUC8 (km) between 0 and 1

RCS_Data_HUC8$HUC8_Scale <- ((RCS_Data_HUC8$total_area_huc8 - min(RCS_Data_HUC8$total_area_huc8))/(max(RCS_Data_HUC8$total_area_huc8, na.rm=TRUE) - min(RCS_Data_HUC8$total_area_huc8, na.rm=TRUE))) #for HUC8

#2g. Scaled AOO for HUC8 and CS values substracted from 1

RCS_Data_HUC8$One_Minus_ScaledHUC8 <- (1 - RCS_Data_HUC8$HUC8_Scale)
RCS_Data_HUC8$One_Minus_CSHuc8 <- (1 - RCS_Data_HUC8$CS)

#2h. Calculate Relative Climate Sensitivity Index by taking average of "1-AOO" and "1-CS" (large values of RCS indicate species with small AOO and low range of climate variables)

RCS_Data_HUC8$RCS <- ((RCS_Data_HUC8$One_Minus_ScaledHUC8 + RCS_Data_HUC8$One_Minus_CSHuc8)/2)


#2i. Exports RCS data table containing RCS values for the HUC 8 scale

write.csv(RCS_Data_HUC8,"C:\\Users\\rrd600\\OneDrive - University of Texas at San Antonio\\Mims\\AOOData\\RCS_HUC8.csv")


########For HUC 12####################


#2a. Imports standard deviations for climatic data that indicate climate breath for each species at the HUC12 level

StandardDevs_HUC12 <- read.csv(file="C:\\Users\\rrd600\\OneDrive - University of Texas at San Antonio\\Mims\\AOOData\\complete_sd_HUC12.csv")

#2b. Scales standard deviations for each climatic variable (n=6) between 0 and 1

StandardDevs_HUC12$SD_TMax_Scale <- ((StandardDevs_HUC12$matrix_sdtmax - min(StandardDevs_HUC12$matrix_sdtmax))/(max(StandardDevs_HUC12$matrix_sdtmax, na.rm=TRUE) - min(StandardDevs_HUC12$matrix_sdtmax, na.rm=TRUE))) #for Tmax
StandardDevs_HUC12$SD_ppt_Scale <- ((StandardDevs_HUC12$matrix_sdppt - min(StandardDevs_HUC12$matrix_sdppt))/(max(StandardDevs_HUC12$matrix_sdppt, na.rm=TRUE) - min(StandardDevs_HUC12$matrix_sdppt, na.rm=TRUE))) 
StandardDevs_HUC12$SD_TMaxAug_Scale <- ((StandardDevs_HUC12$matrix_sdtmaxaug - min(StandardDevs_HUC12$matrix_sdtmaxaug))/(max(StandardDevs_HUC12$matrix_sdtmaxaug, na.rm=TRUE) - min(StandardDevs_HUC12$matrix_sdtmaxaug, na.rm=TRUE))) 
StandardDevs_HUC12$SD_TMin_Scale <- ((StandardDevs_HUC12$matrix_sdtmin - min(StandardDevs_HUC12$matrix_sdtmin))/(max(StandardDevs_HUC12$matrix_sdtmin, na.rm=TRUE) - min(StandardDevs_HUC12$matrix_sdtmin, na.rm=TRUE))) 
StandardDevs_HUC12$SD_TMinJan_Scale <- ((StandardDevs_HUC12$matrix_sdtminjan - min(StandardDevs_HUC12$matrix_sdtminjan))/(max(StandardDevs_HUC12$matrix_sdtminjan, na.rm=TRUE) - min(StandardDevs_HUC12$matrix_sdtminjan, na.rm=TRUE))) 
StandardDevs_HUC12$SD_TMean_Scale <- ((StandardDevs_HUC12$matrix_sdtmean - min(StandardDevs_HUC12$matrix_sdtmean))/(max(StandardDevs_HUC12$matrix_sdtmean, na.rm=TRUE) - min(StandardDevs_HUC12$matrix_sdtmean, na.rm=TRUE))) 

#2c. Calculates the mean of the 6 scaled standard deviations to derive a mean relative climate breath for each species
StandardDevs_HUC12$CS <- ((StandardDevs_HUC12$SD_TMax_Scale + StandardDevs_HUC12$SD_ppt_Scale + StandardDevs_HUC12$SD_TMaxAug_Scale + StandardDevs_HUC12$SD_TMin_Scale + StandardDevs_HUC12$SD_TMinJan_Scale + StandardDevs_HUC12$SD_TMean_Scale )/6)


#2d. Rename columns in AOO dataframe and relative climate breadth dataframe so that they match, and thus that the tables can be merged

names(All_AOO)[2]<-"Species"
names(StandardDevs_HUC12)[1] <-"Species"

#2e. Merge AOO dataframe and relative climate breadth dataframe

RCS_Data_HUC12 <- merge(All_AOO,StandardDevs_HUC12, by.x="Species")


#2f. Scales AOOs defined by HUC12 (km) between 0 and 1

RCS_Data_HUC12$HUC12_Scale <- ((RCS_Data_HUC12$total_area_huc12 - min(RCS_Data_HUC12$total_area_huc12))/(max(RCS_Data_HUC12$total_area_huc12, na.rm=TRUE) - min(RCS_Data_HUC12$total_area_huc12, na.rm=TRUE))) #for HUC12

#2g. Scaled AOO for HUC12 and CS values substracted from 1

RCS_Data_HUC12$One_Minus_ScaledHUC12 <- (1 - RCS_Data_HUC12$HUC12_Scale)
RCS_Data_HUC12$One_Minus_CSHuc12 <- (1 - RCS_Data_HUC12$CS)

#2h. Calculate Relative Climate Sensitivity Index by taking average of "1-AOO" and "1-CS" (large values of RCS indicate species with small AOO and low range of climate variables)

RCS_Data_HUC12$RCS <- ((RCS_Data_HUC12$One_Minus_ScaledHUC12 + RCS_Data_HUC12$One_Minus_CSHuc12)/2)

#2i. Exports RCS data table containing RCS values for the HUC 12 scale

write.csv(RCS_Data_HUC12,"C:\\Users\\rrd600\\OneDrive - University of Texas at San Antonio\\Mims\\AOOData\\RCS_HUC12.csv")

######################for point buffers#######################################

#2a. Imports standard deviations for climatic data that indicate climate breath for each species at the point buffer level


SD_10km_ppt <- read.csv(file="C:\\Users\\rrd600\\Desktop\\sd\\sd_ppt.csv")
SD_10km_tmax <- read.csv(file="C:\\Users\\rrd600\\Desktop\\sd\\sd_tmax.csv")
SD_10km_tmaxAug <- read.csv(file="C:\\Users\\rrd600\\Desktop\\sd\\sd_tmaxAug.csv")
SD_10km_tmean <- read.csv(file="C:\\Users\\rrd600\\Desktop\\sd\\sd_tmean.csv")
SD_10km_tmin <- read.csv(file="C:\\Users\\rrd600\\Desktop\\sd\\sd_tmin.csv")
SD_10km_tminJan <- read.csv(file="C:\\Users\\rrd600\\Desktop\\sd\\sd_tminJan.csv")


#2b. Rename columns in AOO dataframe and relative climate breadth dataframe so that they match, and thus that the tables can be merged

names(SD_10km_ppt)[2]<-"SD_ppt"
names(SD_10km_tmax)[2]<-"SD_tmax"
names(SD_10km_tmaxAug)[2]<-"SD_tmaxAug"
names(SD_10km_tmean)[2]<-"SD_tmean"
names(SD_10km_tmin)[2]<-"SD_tmin"
names(SD_10km_tminJan)[2]<-"SD_tminJan"

SD_10km_all <- cbind(SD_10km_ppt,SD_10km_tmax, SD_10km_tmaxAug, SD_10km_tmean, SD_10km_tmin, SD_10km_tminJan)


#2c. Scales standard deviations for each climatic variable (n=6) between 0 and 1
SD_10km_all$SD_ppt_Scale <- ((SD_10km_all$SD_ppt - min(SD_10km_all$SD_ppt))/(max(SD_10km_all$SD_ppt, na.rm=TRUE) - min(SD_10km_all$SD_ppt, na.rm=TRUE))) 
SD_10km_all$SD_TMax_Scale <- ((SD_10km_all$SD_tmax - min(SD_10km_all$SD_tmax))/(max(SD_10km_all$SD_tmax, na.rm=TRUE) - min(SD_10km_all$SD_tmax, na.rm=TRUE)))
SD_10km_all$SD_TMaxAug_Scale <- ((SD_10km_all$SD_tmaxAug - min(SD_10km_all$SD_tmaxAug))/(max(SD_10km_all$SD_tmaxAug, na.rm=TRUE) - min(SD_10km_all$SD_tmaxAug, na.rm=TRUE))) 
SD_10km_all$SD_TMin_Scale <- ((SD_10km_all$SD_tmin - min(SD_10km_all$SD_tmin))/(max(SD_10km_all$SD_tmin, na.rm=TRUE) - min(SD_10km_all$SD_tmin, na.rm=TRUE))) 
SD_10km_all$SD_TMinJan_Scale <- ((SD_10km_all$SD_tminJan - min(SD_10km_all$SD_tminJan))/(max(SD_10km_all$SD_tminJan, na.rm=TRUE) - min(SD_10km_all$SD_tminJan, na.rm=TRUE)))
SD_10km_all$SD_TMean_Scale <- ((SD_10km_all$SD_tmean - min(SD_10km_all$SD_tmean))/(max(SD_10km_all$SD_tmean, na.rm=TRUE) - min(SD_10km_all$SD_tmean, na.rm=TRUE))) 


#2c. Calculates the mean of the 6 scaled standard deviations to derive a mean relative climate breadth for each species
SD_10km_all$CS <- ((SD_10km_all$SD_ppt_Scale + SD_10km_all$SD_TMax_Scale + SD_10km_all$SD_TMaxAug_Scale + SD_10km_all$SD_TMin_Scale + SD_10km_all$SD_TMinJan_Scale +  SD_10km_all$SD_TMean_Scale)/6)


#2d. Merge AOO dataframe and relative climate breadth dataframe

RCS_Data_10km <- cbind(All_AOO,SD_10km_all)


#2e. Scales AOOs defined by HUC8 (km) between 0 and 1

RCS_Data_10km$Buffer10km_Scale <- ((RCS_Data_10km$total_area_10km - min(RCS_Data_10km$total_area_10km ))/(max(RCS_Data_10km$total_area_10km , na.rm=TRUE) - min(RCS_Data_10km$total_area_10km , na.rm=TRUE))) #for HUC8


#2f. Scaled AOO for HUC8 and CS values substracted from 1

RCS_Data_10km$One_Minus_Scaled10km <- (1 - RCS_Data_10km$Buffer10km_Scale)
RCS_Data_10km$One_Minus_CS10km <- (1 - RCS_Data_10km$CS)

#2g. Calculate Relative Climate Sensitivity Index by taking average of "1-AOO" and "1-CS" (large values of RCS indicate species with small AOO and low range of climate variables)

RCS_Data_10km$RCS <- ((RCS_Data_10km$One_Minus_Scaled10km + RCS_Data_10km$One_Minus_CS10km)/2)


#2i. Exports RCS data table containing RCS values for the HUC 8 scale

write.csv(RCS_Data_10km,"C:\\Users\\rrd600\\Desktop\\RCS\\RCS_10km.csv")



