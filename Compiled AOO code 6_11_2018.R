#Compiled code of "Converting file to Csv", "Delete missing Long-Lat-Year", 
#"Clean Issues", "US only"
#"HUC8 AOO", "HUC12 AOO", "1,5,10,20 KM BUFFER AOO", "MCP AOO"
#Individual Code by S Yamada and Y Chen
#Compliled and edited by Y Chen
#5 JUNE 2018
rm(list=ls())

#install.packages(package name) ; run this command for packages that are not installed
library(ggpubr)
library(sf)
library(ggplot2)
library(mapdata)
library(sp)
library(maps)
library(rgdal)
library(maptools)
library(RColorBrewer)
library(mapproj)
library(ggmap)
library(rgeos)
library(dplyr)
library(geosphere)
library(adehabitatHR) 

#change path to own before running
setwd("C:/Users/MimsLab/Documents/Ye/GBIF") #set working directory to path of raw data

FILES = list.files(path = "C:\\Users\\MimsLab\\Documents\\Ye\\GBIF") #path of raw data
for(i in 1:length(FILES)){
  datfile <- read.delim(FILES[i], na.strings = c("NA", " ", "")) #read in the file
  Scientific.Name <- datfile[2,10] #find the specie name
  write.csv(datfile, file = paste0("C:\\Users\\MimsLab\\Documents\\Ye\\GBIF renamed\\", Scientific.Name, ".csv"), row.names = FALSE) #save the file with the specie name
}

FILES1 = list.files(path = "C:\\Users\\MimsLab\\Documents\\Ye\\GBIF renamed") #path of renamed raw data 
FILES_NEW =  NULL #create empty list 

setwd("C:/Users/MimsLab/Documents/Ye/GBIF renamed/") #path for the renamed files
#keep only files with more than 50 observations
for( i in 1:length(FILES1)){
  if(length(count.fields(FILES1[i], skip = 1)) > 50){ #skip the header, count the file to to check for greater than 50 observations
    FILES_NEW[i] <- FILES1[i] #put the  > 50 in a few list
  }
}

FILES_NEW <- unique(FILES_NEW) #get rid of duplicate files 
FILES_NEW <- na.omit(FILES_NEW) #get rid of the NULL that was created when creating FILES_NEW

#gets maps needed for subsetting and plotting
US <- map_data("state")#converts state map to dataframe for mapping with ggplot2
usa <- map("usa") #gets map for subsetting entries
main <- map_data("usa", region=c("main"))#subsets map points to only mainland, no islands

#converts from dataframe to spatial polygon
df <- data.frame(main$long, main$lat) #dataframe of longitude and latitude 
p <- Polygon(df)
ps<- Polygons(list(p), ID=1)
USAsp <- SpatialPolygons(list(ps), proj4string = CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84")) #spatial polygon of the desired location
#from https://rstudio-pubs-static.s3.amazonaws.com/202536_7a122ff56e9f4062b6b012d9921afd80.html  

#downloads estuary shapefiles and combines them
estuary <- st_read("C:/Users/MimsLab/Documents/Ye/merged estuary/Merged_estuaries.shp", layer="merged_estuaries") # read in the estuary shaped file
est <- st_transform(estuary, 4326) #transform to desire location code
#estbuf <- st_buffer(est, units::set_units(0.00898, degree)) #1 degree=111325m, 0.00898=1000m buffer, 0.00449=500m buffer, 0.0022457=250m buffer, 0.001797=200mbuffer, 0.001347=150m buffer, 0.000449=50m buffer, 0.000898 gives buffer of decimal degrees equal to 100m
ests <- as(est, "Spatial")
estsp <- as(ests, "SpatialPolygons")

estsp <- spTransform(estsp, CRS="+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84") 
proj4string(estsp) <- CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84")


ext = NULL # create empty list

setwd("C:\\Users\\MimsLab\\Documents\\Ye\\GBIF renamed\\")
for(i in 1:length(FILES_NEW)){
  
  datfile <- read.csv(FILES_NEW[i], header=TRUE) #read in the file from  the list
  datfile1 <- datfile[!is.na(datfile$decimallatitude),] #delete rows with missing latitude
  datfile2 <- datfile1[!is.na(datfile1$decimallongitude),] #delete rows with missing longitude
  datfile3 <- datfile2[!is.na(datfile2$year),] #delete rows with missing year
  
  #find issue and delete those rows
  df1 <- datfile3[!grepl("COUNTRY_COORDINATE_MISMATCH", datfile3$issue),]#COUNTRY_COORDINATE_MISMATCH
  df2 <- df1[!grepl("IDENTIFIED_DATE_UNLIKELY", df1$issue),]#IDENTIFIED_DATE_UNLIKELY
  df3 <- df2[!grepl("RECORDED_DATE_MISMATCH", df2$issue),]#RECORDED_DATE_MISMATCH
  df4 <- df3[!grepl("ZERO_COORDINATE", df3$issue),]#ZERO_COORDINATE
  df5 <- df4[!is.na(df4$gbifid),]#delete all NA values in gbifid column
  df6 <- df5[!is.na(df5$countrycode),]#delete all NA values in countrycode column
  df7 <- df6[grepl("US", df6$countrycode),] #returns only US entries

  SpeciesName <- as.character(df1$species[2]) #species name for file name
  USentries <- sum(df1$countrycode=="US") ## of US entries
  ext <- rbind(ext, data.frame(SpeciesName, USentries)) #combines data frame with previous data frame
  write.csv(df7, file = paste0("C:/Users/MimsLab/Documents/Ye/first cleaned data/", SpeciesName, ".csv"), row.names=FALSE) #output the file as csv
  

}

FILES_SHP <- list.files(path="C:/Users/MimsLab/Documents/Ye/shape files", pattern = "\\.shp$")#create file list for loop


#compare data from above loop to shapefiles 
for (i in 1:length(FILES_SHP)){ #loop
  
  
  #downloads estuary shapefiles and combines them
  #*change to loop through maps*
  maps <- st_read(paste("C:/Users/MimsLab/Documents/Ye/shape files/",FILES_SHP[i],sep=""), layer=substr(FILES_SHP[i], 1, nchar(FILES_SHP[i])-4)) #read in the shape files
  
  map1 <- st_transform(maps, 4326)
  map2 <- as(map1, "Spatial")
  map3 <- as(map2, "SpatialPolygons")
  
  map3 <- spTransform(map3, CRS="+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84") #projected to correct location
  proj4string(map3) <- CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84")
  
  #uploads csv, converts to SpatialPointsDataFrame for subsetting points to lower 48
  setwd("C:/Users/MimsLab/Documents/Ye/first cleaned data/") #path to cleaned data from above loop
  
  dat.name <- substr(FILES_SHP[i], 1, nchar(FILES_SHP[i])-4) #take the shape file name
  dat.name2 <- strsplit(dat.name, "[_]") #get rid of underscores
  dat.name3 <- sapply(dat.name2, paste, collapse =" ") #add a space between names
  dat <- read.csv(paste(dat.name3,".csv", sep=""), header=TRUE) # read in the file with the new name
  #elim <- dat[grep("Estuary",dat$locality),] #subsets those records with Estuary in column "locality"
  #noest <- dat[!dat$gbifid %in% elim$gbifid,] #eliminates those records with Estuary in column "locality"
  datf <- data.frame(dat$decimallongitude, dat$decimallatitude, dat$year) #data frame of longitude, latitude, and year
  datfsp <- SpatialPointsDataFrame(datf, dat, proj4string = CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84"))#spatial data frame with correct projection
                                                               
  pts_subset <- datfsp[USAsp,]#subsets occurrence points to those of mainland lower 48 from http://robinlovelace.net/r/2014/07/29/clipping-with-r.html
  pointsUS <- as.data.frame(datfsp)#changes spatial points to a dataframe for mapping with ggplot2
  
  #subset estuarine records
  subsetpt <- pts_subset#[estsp,]#subsets occurrence points to those of estuary
  pointsest <- as.data.frame(subsetpt)#changes spatial points to a dataframe for mapping with ggplot2
  final <- pointsUS[(pointsUS$gbifid %in% pointsest$gbifid),] #takes out occurrence records in estuaries
  
  #cleans up extra columns in dataframe and writes file with subsetted records
  final$dat.decimallatitude <- NULL 
  final$dat.decimallongitude <- NULL
  final$dat.year <- NULL
  
  SpeciesName <- as.character(final[2,10]) #get species name for title of plot
  write.csv(final, file=paste0("C:/Users/MimsLab/Documents/Ye/Final location data/", dat.name3, ".csv"), row.names = FALSE) #save final data to new location
  
}

#calculate areas of unique HUC8 for each specie


setwd("C:\\Users\\MimsLab\\Documents\\Ye\\Final location data")
#read in the HUC8 shapefile
HUC8 <- readOGR("C:\\Users\\MimsLab\\Documents\\Ye\\HUC8", "HUC8")

#read in final location data
FILES_FINAL = list.files(path = "C:\\Users\\MimsLab\\Documents\\Ye\\Final location data")

total_area_huc8 = NULL
species_name = NULL 

for(i in 1:length(FILES_FINAL)){
  dat <- read.csv(FILES_FINAL[i], header=TRUE) #read each file
  dat1 <- data.frame(dat$decimallongitude, dat$decimallatitude) #create a data frame of long and lat 
  
  #turning the data into a spatial dataframe
  dat1dfsp <- SpatialPointsDataFrame(dat1, dat, proj4string = CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 
                                                                  +datum=WGS84"))
  
  
  # tell R that coordinates are in the same lat/lon reference system as the HUC8 data
  proj4string(dat1dfsp) <- proj4string(HUC8)
  
  dat$HUC8 <- over(dat1dfsp, HUC8)$HUC8 #store the HUC8 name as an attribute of the fish data 
  
  dat = dat[, c(1,45, 2:44)] #rearrange HUC8 to be the 2nd column
  
  Number_of_HUC8s <- data.frame(unique(dat$HUC8)) #number of unique HUC8's
  
  HUC8species = HUC8[Number_of_HUC8s$unique.dat.HUC8. %in% HUC8$HUC8,]  #extract unique HUC8 data for the specie 
  
  SpeciesName <- as.character(dat[2,11]) #get species name for title of plot
  
  write.csv(HUC8species, file=paste0("C:/Users/MimsLab/Documents/Ye/unique HUC8 data/", SpeciesName, ".csv"), row.names = FALSE)
  
  total_area_huc8[[i]] <- sum(HUC8species$AreaSqKm) #sum the total area (square kilometer) for each unique HUC8's
  
  species_name[[i]] <- SpeciesName
  
}

area_all_huc8 <- as.data.frame(cbind(species_name, total_area_huc8)) #combined species and its total area

write.csv(area_all_huc8, file = "C:\\Users\\MimsLab\\Documents\\Ye\\unique HUC8 data\\total area\\total_area_huc8.csv")  #save the dataframe


#calculate areas of unique HUC12 of each specie

#read in the HUC12 shapefile
HUC12 <- readOGR("C:\\Users\\MimsLab\\Documents\\Ye\\HUC12", "HUC12")

#read in final location data
FILES_FINAL = list.files(path = "C:\\Users\\MimsLab\\Documents\\Ye\\Final location data")

total_area_huc12 = NULL # empty list  
species_name = NULL #reset to empty list

for(i in 1:length(FILES_FINAL)){
  dat <- read.csv(FILES_FINAL[i], header=TRUE) #read each file
  dat1 <- data.frame(dat$decimallongitude, dat$decimallatitude) #create a data frame of long and lat 
  
  #turning the data into a spatial dataframe
  dat1dfsp <- SpatialPointsDataFrame(dat1, dat, proj4string = CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 
                                                                  +datum=WGS84"))
  
  
  # tell R that coordinates are in the same lat/lon reference system as the HUC12 data
  proj4string(dat1dfsp) <- proj4string(HUC12)
  
  dat$HUC12 <- over(dat1dfsp, HUC12)$HUC12 #store the HUC12 name as an attribute of the fish data 
  
  dat = dat[, c(1,45, 2:44)] #rearrange HUC12 to be the 2nd column
  
  Number_of_HUC12s <- data.frame(unique(dat$HUC12)) #number of unique HUC12's
  
  HUC12species = HUC12[Number_of_HUC12s$unique.dat.HUC12. %in% HUC12$HUC12,]  #extract unique HUC12 data for the specie 
  
  SpeciesName <- as.character(dat[2,11]) #get species name for title of plot
  
  write.csv(HUC12species, file=paste0("C:/Users/MimsLab/Documents/Ye/unique HUC12 data/", SpeciesName, ".csv"), row.names = FALSE)
  
  total_area_huc12[[i]] <- sum(HUC12species$AreaSqKm) #sum the total area (square kilometer) for each unique HUC12's
  
  species_name[[i]] <- SpeciesName
  
}

area_all_huc12 <- as.data.frame(cbind(species_name, total_area_huc12))

write.csv(area_all_huc12, file = "C:\\Users\\MimsLab\\Documents\\Ye\\unique HUC12 data\\total area\\total_area_huc12.csv") #save the dataframe


#Generate buffers for 1km, 5km, 10km, 20km

US <- map_data("state")#converts state map to dataframe for mapping with ggplot2
usa <- map("usa") #gets map for subsetting entries
main <- map_data("usa", region=c("main"))#subsets map points to only mainland, no islands

df <- data.frame(main$long, main$lat) #dataframe of longitude and latitude
p <- Polygon(df)
ps<- Polygons(list(p), ID=1)
USAsp <- SpatialPolygons(list(ps), proj4string = CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84"))

FILES_BUFFER <- list.files(path="C:/Users/MimsLab/Documents/Ye/buffer map/data file/")#path for buffer clipped files
ext=NULL

total_area_1km = NULL #create empty list
total_area_5km = NULL #create empty list
total_area_10km = NULL #create empty list
total_area_20km = NULL #create empty list

species_name = NULL #create empty list

# for loop to generate buffers for each species 
for (i in 1:length(FILES_BUFFER)){
  #1km
  dat <-read.csv(FILES_BUFFER[i], header=TRUE) #read in file from list
  
  dat1 <- dat
  datf <- data.frame(dat$decimallongitude, dat$decimallatitude) #create dataframe of longitude and latitude
  datfsp <- SpatialPointsDataFrame(datf,dat1, proj4string = CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 #create spatial df with correct projection
                                                                +datum=WGS84")) 
  
  d_mrc <- spTransform(datfsp,CRS("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs")) 
  
  d_mrc_buffer_range <- gBuffer(d_mrc, width = 1000, byid= FALSE) #create a buffer of 1 km 
  
  d_mrc_buffer <- spTransform(d_mrc_buffer_range, CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84
                                                      +datum=WGS84"))
  d_mrc_buffer_fort <- fortify(d_mrc_buffer)
  
  
  pts_subset <- datfsp[USAsp,]#subsets occurrence points to those of mainland lower 48 from http://robinlovelace.net/r/2014/07/29/clipping-with-r.html
  pointsUS <- as.data.frame(pts_subset)#changes spatial points to a dataframe for mapping with ggplot2
  
  
  #subset estuarine records
  subsetpt <- pts_subset#[estsp,]#subsets occurrence points to those of estuary
  pointsest <- as.data.frame(subsetpt)#changes spatial points to a dataframe for mapping with ggplot2
  final <- pointsUS#[!pointsUS$gbifid %in% pointsest$gbifid,] #takes out occurrence records in estuaries
  
  #cleans up extra columns in dataframe and writes file with subsetted records
  final$dat1.decimallatitude <- NULL
  final$dat1.decimallongitude <- NULL
  final$dat1.year <- NULL
  SpeciesName <- as.character(final$species[2])
  
  #graph the data points with buffer
  ggplot()+
    geom_polygon(data=US, aes(x=long, y=lat, group=group), fill=NA, color="black")+ #USmap with state boundaries
    geom_point(data=pointsUS,shape=21, color="gray37",alpha=0.4, aes(x=pointsUS$decimallongitude, y=pointsUS$decimallatitude, fill=pointsUS$year))+ #plot points of occurrence
    scale_fill_gradientn(colors=brewer.pal(11, "Spectral"))+ #fills in the points with palette Spectral, limit 11 divisions 
    labs(fill="Year")+ #labels legend title
    geom_path(data=d_mrc_buffer_fort, aes(long, lat, group=group), color="red") +
    coord_map("albers", lat0=30, lat1=40) + #designates coordinate system as albers, used parameters found on website https://rud.is/b/2015/07/24/a-path-towards-easier-map-projection-machinations-with-ggplot2/
    ggtitle(SpeciesName) #title for plot      
  
  ggsave(file=paste0("C:/Users/MimsLab/Documents/Ye/buffer map/1 km buffer/", SpeciesName, ".pdf")) #saves plot as pdf file
  
  total_area_1km[[i]] <-  gArea(d_mrc_buffer_range, byid = FALSE) #generate list of area by species
  species_name[[i]] <- SpeciesName #list of species name
  
  #5km
  dat <-read.csv(FILES_BUFFER[i], header=TRUE) #read in the files from list
  
  dat1 <- dat
  datf <- data.frame(dat$decimallongitude, dat$decimallatitude) #create dataframe of longitude and latitude
  datfsp <- SpatialPointsDataFrame(datf,dat1, proj4string = CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84
                                                                +datum=WGS84")) 
  
  d_mrc <- spTransform(datfsp,CRS("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs")) 
  
  d_mrc_buffer_range <- gBuffer(d_mrc, width = 5000, byid= FALSE) #create buffer of size 5km
  
  d_mrc_buffer <- spTransform(d_mrc_buffer_range, CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84
                                                      +datum=WGS84"))
  d_mrc_buffer_fort <- fortify(d_mrc_buffer)
  
  
  pts_subset <- datfsp[USAsp,]#subsets occurrence points to those of mainland lower 48 from http://robinlovelace.net/r/2014/07/29/clipping-with-r.html
  pointsUS <- as.data.frame(pts_subset)#changes spatial points to a dataframe for mapping with ggplot2
  
  
  #subset estuarine records
  subsetpt <- pts_subset#[estsp,]#subsets occurrence points to those of estuary
  pointsest <- as.data.frame(subsetpt)#changes spatial points to a dataframe for mapping with ggplot2
  final <- pointsUS#[!pointsUS$gbifid %in% pointsest$gbifid,] #takes out occurrence records in estuaries
  
  #cleans up extra columns in dataframe and writes file with subsetted records
  final$dat1.decimallatitude <- NULL
  final$dat1.decimallongitude <- NULL
  final$dat1.year <- NULL
  SpeciesName <- as.character(final$species[2])
  
  ggplot()+
    geom_polygon(data=US, aes(x=long, y=lat, group=group), fill=NA, color="black")+ #USmap with state boundaries
    geom_point(data=pointsUS,shape=21, color="gray37",alpha=0.4, aes(x=pointsUS$decimallongitude, y=pointsUS$decimallatitude, fill=pointsUS$year))+ #plot points of occurrence
    scale_fill_gradientn(colors=brewer.pal(11, "Spectral"))+ #fills in the points with palette Spectral, limit 11 divisions 
    labs(fill="Year")+ #labels legend title
    geom_path(data=d_mrc_buffer_fort, aes(long, lat, group=group), color="red") +
    coord_map("albers", lat0=30, lat1=40) + #designates coordinate system as albers, used parameters found on website https://rud.is/b/2015/07/24/a-path-towards-easier-map-projection-machinations-with-ggplot2/
    ggtitle(SpeciesName) #title for plot      
  
  ggsave(file=paste0("C:/Users/MimsLab/Documents/Ye/buffer map/5 km buffer/", SpeciesName, ".pdf")) #saves plot as pdf file
  
  total_area_5km[[i]] <-  gArea(d_mrc_buffer_range, byid = FALSE) #generate list of area by species
  species_name[[i]] <- SpeciesName #list of species name
  
  #10km
  dat <-read.csv(FILES_BUFFER[i], header=TRUE)
  
  dat1 <- dat
  datf <- data.frame(dat$decimallongitude, dat$decimallatitude) #create df of longitude and latitude
  datfsp <- SpatialPointsDataFrame(datf,dat1, proj4string = CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84
                                                                +datum=WGS84")) 
  
  d_mrc <- spTransform(datfsp,CRS("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs")) 
  
  d_mrc_buffer_range <- gBuffer(d_mrc, width = 10000, byid= FALSE) #create buffer of size 10km
  
  d_mrc_buffer <- spTransform(d_mrc_buffer_range, CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84
                                                      +datum=WGS84"))
  d_mrc_buffer_fort <- fortify(d_mrc_buffer)
  
  
  pts_subset <- datfsp[USAsp,]#subsets occurrence points to those of mainland lower 48 from http://robinlovelace.net/r/2014/07/29/clipping-with-r.html
  pointsUS <- as.data.frame(pts_subset)#changes spatial points to a dataframe for mapping with ggplot2
  
  
  #subset estuarine records
  subsetpt <- pts_subset#[estsp,]#subsets occurrence points to those of estuary
  pointsest <- as.data.frame(subsetpt)#changes spatial points to a dataframe for mapping with ggplot2
  final <- pointsUS#[!pointsUS$gbifid %in% pointsest$gbifid,] #takes out occurrence records in estuaries
  
  #cleans up extra columns in dataframe and writes file with subsetted records
  final$dat1.decimallatitude <- NULL
  final$dat1.decimallongitude <- NULL
  final$dat1.year <- NULL
  SpeciesName <- as.character(final$species[2])
  
  ggplot()+
    geom_polygon(data=US, aes(x=long, y=lat, group=group), fill=NA, color="black")+ #USmap with state boundaries
    geom_point(data=pointsUS,shape=21, color="gray37",alpha=0.4, aes(x=pointsUS$decimallongitude, y=pointsUS$decimallatitude, fill=pointsUS$year))+ #plot points of occurrence
    scale_fill_gradientn(colors=brewer.pal(11, "Spectral"))+ #fills in the points with palette Spectral, limit 11 divisions 
    labs(fill="Year")+ #labels legend title
    geom_path(data=d_mrc_buffer_fort, aes(long, lat, group=group), color="red") +
    coord_map("albers", lat0=30, lat1=40) + #designates coordinate system as albers, used parameters found on website https://rud.is/b/2015/07/24/a-path-towards-easier-map-projection-machinations-with-ggplot2/
    ggtitle(SpeciesName) #title for plot      
  
  ggsave(file=paste0("C:/Users/MimsLab/Documents/Ye/buffer map/10 km buffer/", SpeciesName, ".pdf")) #saves plot as pdf file
  
  total_area_10km[[i]] <-  gArea(d_mrc_buffer_range, byid = FALSE) #generate list of area by species
  species_name[[i]] <- SpeciesName #list of species name
  
  #20km
  dat <-read.csv(FILES_BUFFER[i], header=TRUE)
  
  dat1 <- dat
  datf <- data.frame(dat$decimallongitude, dat$decimallatitude) #create df of longitude and latitude
  datfsp <- SpatialPointsDataFrame(datf,dat1, proj4string = CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84
                                                                +datum=WGS84")) 
  
  d_mrc <- spTransform(datfsp,CRS("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs")) 
  
  d_mrc_buffer_range <- gBuffer(d_mrc, width = 20000, byid= FALSE) #create buffer of size 20km
  
  d_mrc_buffer <- spTransform(d_mrc_buffer_range, CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84
                                                      +datum=WGS84"))
  d_mrc_buffer_fort <- fortify(d_mrc_buffer)
  
  
  pts_subset <- datfsp[USAsp,]#subsets occurrence points to those of mainland lower 48 from http://robinlovelace.net/r/2014/07/29/clipping-with-r.html
  pointsUS <- as.data.frame(pts_subset)#changes spatial points to a dataframe for mapping with ggplot2
  
  
  #subset estuarine records
  subsetpt <- pts_subset#[estsp,]#subsets occurrence points to those of estuary
  pointsest <- as.data.frame(subsetpt)#changes spatial points to a dataframe for mapping with ggplot2
  final <- pointsUS#[!pointsUS$gbifid %in% pointsest$gbifid,] #takes out occurrence records in estuaries
  
  #cleans up extra columns in dataframe and writes file with subsetted records
  final$dat1.decimallatitude <- NULL
  final$dat1.decimallongitude <- NULL
  final$dat1.year <- NULL
  SpeciesName <- as.character(final$species[2])
  
  ggplot()+
    geom_polygon(data=US, aes(x=long, y=lat, group=group), fill=NA, color="black")+ #USmap with state boundaries
    geom_point(data=pointsUS,shape=21, color="gray37",alpha=0.4, aes(x=pointsUS$decimallongitude, y=pointsUS$decimallatitude, fill=pointsUS$year))+ #plot points of occurrence
    scale_fill_gradientn(colors=brewer.pal(11, "Spectral"))+ #fills in the points with palette Spectral, limit 11 divisions 
    labs(fill="Year")+ #labels legend title
    geom_path(data=d_mrc_buffer_fort, aes(long, lat, group=group), color="red") +
    coord_map("albers", lat0=30, lat1=40) + #designates coordinate system as albers, used parameters found on website https://rud.is/b/2015/07/24/a-path-towards-easier-map-projection-machinations-with-ggplot2/
    ggtitle(SpeciesName) #title for plot      
  
  ggsave(file=paste0("C:/Users/MimsLab/Documents/Ye/buffer map/20 km buffer/", SpeciesName, ".pdf")) #saves plot as pdf file
  
  total_area_20km[[i]] <-  gArea(d_mrc_buffer_range, byid = FALSE) #generate list of area by species
  species_name[[i]] <- SpeciesName #list of species name
}

area_1Km <- as.data.frame(cbind(species_name, total_area_1km)) #bind species name and area to create data frame

write.csv(area_1Km, file = "C:\\Users\\MimsLab\\Documents\\Ye\\total area from buffer\\1 km area.csv") #save the dataframe

area_5Km <- as.data.frame(cbind(species_name, total_area_5km)) #bind species name and area to create data frame

write.csv(area_5Km, file = "C:\\Users\\MimsLab\\Documents\\Ye\\total area from buffer\\5 km area.csv") #save the dataframe

area_10Km <- as.data.frame(cbind(species_name, total_area_10km)) #bind species name and area to create data frame

write.csv(area_10Km, file = "C:\\Users\\MimsLab\\Documents\\Ye\\total area from buffer\\10 km area.csv") #save the dataframe

area_20Km <- as.data.frame(cbind(species_name, total_area_20km)) #bind species name and area to create data frame

write.csv(area_20Km, file = "C:\\Users\\MimsLab\\Documents\\Ye\\total area from buffer\\20 km area.csv") #save the dataframe

#Output the MCP graph for each species
setwd("C:/Users/MimsLab/Documents/Ye/Final location data")

FILES_MCP <- list.files(path = "C:\\Users\\MimsLab\\Documents\\Ye\\Final location data") #path where you store the final cleaned data
species_name <- NULL #empty list  
mcp_area <- NULL #empty list

for(i in 1:length(FILES_MCP)){
  datfile <- read.delim(FILES_MCP[i], na.strings = c("NA", " ", ""), sep=",")
  SpeciesName1 <- as.character(datfile[2,10])
  dfxy <- data.frame(datfile$decimallongitude, datfile$decimallatitude)
  
  dfxy <- SpatialPoints(dfxy)
  
  proj4string(dfxy) <- CRS('+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84')
  
  dfxy_alber <- spTransform(dfxy,CRS("+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=37.5 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"))
  
  cp <- mcp(dfxy_alber, percent = 100)
  
  df_points <- as.data.frame(dfxy_alber)
  
  pdf(file = paste0("C:\\Users\\MimsLab\\Documents\\Ye\\MCP maps\\", SpeciesName1, ".pdf"))
  
  plot(cp, main = SpeciesName1)
  points(df_points, col="red")
  
  dev.off()
  
  mcp_area[[i]] <- mcp.area(dfxy_alber ,unout  = "km2", percent = 100, plotit = FALSE)
  species_name[[i]] <- SpeciesName1
}

mcp_area1 <- data.frame(matrix(unlist(mcp_area), nrow = length(mcp_area), byrow = T)) #turn the list into a dataframe
names(mcp_area1)[1] <- "MCP area (Km^2)"
mcp_all <- as.data.frame(cbind(species_name, mcp_area1))
write.csv(mcp_all, file = "C:\\Users\\MimsLab\\Documents\\Ye\\MCP maps\\mcp all.csv") #save the dataframe




