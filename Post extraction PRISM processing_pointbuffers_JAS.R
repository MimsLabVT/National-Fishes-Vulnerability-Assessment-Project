
rm(list=ls())

library(sp)
library(rgdal)
library(maps)
install.packages("zoo")
library(zoo)
install.packages('reshape2')
library(reshape2)

#folder path for all the final data files
#change path
FILES_FINALDATA <- list.files(path="C:\\Users\\rrd600\\Desktop\\Final location data")#create file list for loop


#folder path for all of the bufferpoint prism data
#you will need to change the path for the different metrics
FILES_PRISMBUFFERPOINTS <- list.files(path="C:\\Users\\rrd600\\Desktop\\1km\\tmean\\tmean")#create file list for loop
FILES_PRISMBUFFERPOINTS <- FILES_PRISMBUFFERPOINTS[-57] #gambusia (don't need to run if no error from loop during occurrence point)


# STEP ONE: creating moving window for buffer prism data
for (i in 1:length(FILES_PRISMBUFFERPOINTS)){
  setwd("C:\\Users\\rrd600\\Desktop\\Final location data")
  datfilebufferpoint <- read.csv(FILES_FINALDATA[i], header=TRUE, check.names = FALSE) #read in the file from  the list
  setwd("C:\\Users\\rrd600\\Desktop\\1km\\ppt\\ppt")
  
  #below is where you have all the prism data
  datfilebufferprism <- read.csv(FILES_PRISMBUFFERPOINTS[i], header=TRUE, check.names = FALSE) #read in the file from  the list
  rownames(datfilebufferprism) <- datfilebufferpoint$gbifid
  datfilebufferprism <- datfilebufferprism[-1]
  datfilebufferprism <- as.data.frame(t(datfilebufferprism))
  RW_min <- as.data.frame(rollapply(datfilebufferprism, width = 30, by = 1, FUN = min, na.rm = TRUE))
  rownames(RW_min) <- c(1925:2014)
  #change path to where you want to save the new moving window
  write.csv(RW_min, file =paste0("C:\\Users\\rrd600\\Desktop\\Moving Window\\1km\\ppt\\", FILES_PRISMBUFFERPOINTS[i]), row.names=TRUE)
  
}


#STEP TWO - creating pivot tables from occurrence data
for (i in 1:length(FILES_FINALDATA)){
  #read in specie location file and create pivot table then save
  setwd("C:\\Users\\rrd600\\Desktop\\Final location data")
  species <- read.csv(FILES_FINALDATA[i], header = TRUE)
  ptable_df <- data.frame(species$gbifid, species$year)
  ptable_df[3] <- 1
  ptable_df <- unique(ptable_df)
  
  pivot_table <- acast(ptable_df, ptable_df$species.gbifid ~ ptable_df$species.year)
  speciename <- as.character(species[2,10])
  
  write.csv(pivot_table, file =paste0("C:\\Users\\rrd600\\Desktop\\pivottables\\",speciename,"_PT.csv"), row.names=TRUE,na ="0")
  
}


#STEP THREE - adjusting year and buffer specific PRISM data for occupancy of buffers


#folder path for all of the bufferpoint pivot tables
#change path 
FILES_PTABLEBUFFERPOINTS <- list.files(path="C:\\Users\\rrd600\\Desktop\\pivottables")#create file list for loop
FILES_PTABLEBUFFERPOINTS <- FILES_PTABLEBUFFERPOINTS[-57] #gambusia (don't need to run if no error from loop during occurrence point)


#folder path for all bufferpoint moving window prism data
FILES_PRISMMOVINGWINDOWBP <- list.files(path="C:\\Users\\rrd600\\Desktop\\Moving Window\\1km\\tmean")#create file list for loop
FILES_PRISMMOVINGWINDOWBP <- FILES_PRISMMOVINGWINDOWBP[-57] #gambusia (don't need to run if no error from loop during occurrence point)

#matrix to filled out with standard deviation data by specie
matrix_sd <- NULL



specie_list <- rep(NA, length(FILES_PTABLEBUFFERPOINTS))

for (i in 1:length(FILES_PTABLEBUFFERPOINTS)){
  #path for folder with pivot table files
  #change for bufferpoints pt
  setwd("C:\\Users\\rrd600\\Desktop\\pivottables")
  #read in pivot table file, change column and row name
  #turn into a matrix and get rid of years above 2014
  ptable_bp <- read.csv(FILES_PTABLEBUFFERPOINTS[i], header=TRUE, check.names = FALSE)
   
  colnames(ptable_bp)[1] <- "GBIFID"
  rownames(ptable_bp) <- ptable_bp$GBIFID
  ptable_bp <- ptable_bp[-1]
  ptable_bp <- as.matrix(ptable_bp[1:length(colnames(ptable_bp))])
  ptable_bp <- ptable_bp[,!colnames(ptable_bp) > 2014]
  ptable_bp <- t(ptable_bp)
  
  #change for prism bp moving window folder
  setwd("C:\\Users\\rrd600\\Desktop\\Moving Window\\1km\\tmean")
  #read in prism data by moving window for occurence points, change row and column name then turn into matrix
  mwindow_bp <- read.csv(FILES_PRISMMOVINGWINDOWBP[i], header=TRUE, check.names=FALSE) #JAS CHANGED THIS
  rownames(mwindow_bp) <- mwindow_bp[,1]
  mwindow_bp <- mwindow_bp[-1]
  mwindow_bp <- as.matrix(mwindow_bp[1:length(colnames(mwindow_bp))])
  
  #cross filter between pivot table and prism data to only keep relevant years
  filtered_mwindow_bp <- mwindow_bp[rownames(mwindow_bp) %in% rownames(ptable_bp),]
  filtered_ptable_bp <- ptable_bp[rownames(ptable_bp) %in% rownames(filtered_mwindow_bp),]

  #element wise multiplication to create matrix of of values that has an occurence, else empty
  a <- filtered_ptable_bp * filtered_mwindow_bp
  b <- a
  b[b==0] <- NA
  #create list of specie name
  specie_list[i] <- sub(".csv","", FILES_PTABLEBUFFERPOINTS[i])
  #sd value for a specie
  matrix_sd[i] <- sd(b,na.rm=TRUE)
  
  #matrix of values for years that have occurrences, all else are empty
  #save to folder, change to desired
  write.csv(a, file = paste0("C:\\Users\\rrd600\\Desktop\\ptANDmw\\1km\\tmean\\",sub(".csv","", FILES_PTABLEBUFFERPOINTS[i]), ".csv"), row.names=TRUE)
  
}

specie_matrixsd <- NULL

#combine specie name and related sd
specie_matrixsd <- cbind(specie_list, matrix_sd)
#save the combined file to location
#change the paste location to where you want to and what it's called
write.csv(specie_matrixsd, file = paste0("C:\\Users\\rrd600\\Desktop\\sd\\1km\\sd_tmean.csv"), row.names=FALSE) #output the file as csv















