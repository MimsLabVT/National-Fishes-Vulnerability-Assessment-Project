#Compiled code of "Converting file to Csv", "Delete missing Long-Lat-Year", 
#"Clean Issues", and "US only"
#Individual Code by S Yamada
#Compliled and edited by Y Chen
#15 March 2018
rm(list=ls())

library(ggpubr)
library(sf)
library(ggplot2)
library(mapdata)
library(sp)
library(maps)
library(rgdal)
library(maptools)
library(RColorBrewer)
library(mapproj)
library(ggmap)
library(rgeos)
library(dplyr)
library(geosphere)

setwd("C:/Users/MimsLab/Documents/Ye/preclipped data")

FILES = list.files(path = "C:\\Users\\MimsLab\\Documents\\Ye\\preclipped data") #change path to desired
FILES_NEW =  NULL #create empty list 

#keep only files with more than 50 observations
for( i in 1:length(FILES)){
  if(length(count.fields(FILES[i], skip = 1)) > 50){
    FILES_NEW[i] <- FILES[i]
  }
}

FILES_NEW <- unique(FILES_NEW) #get rid of duplicate files
FILES_NEW <- na.omit(FILES_NEW) #get rid of the NULL that was created when creating FILES_NEW

#gets maps needed for subsetting and plotting
US <- map_data("state")#converts state map to dataframe for mapping with ggplot2
usa <- map("usa") #gets map for subsetting entries
main <- map_data("usa", region=c("main"))#subsets map points to only mainland, no islands

#converts from dataframe to spatial polygon
df <- data.frame(main$long, main$lat)
p <- Polygon(df)
ps<- Polygons(list(p), ID=1)
USAsp <- SpatialPolygons(list(ps), proj4string = CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84"))
#from https://rstudio-pubs-static.s3.amazonaws.com/202536_7a122ff56e9f4062b6b012d9921afd80.html  

#downloads estuary shapefiles and combines them
estuary <- st_read("C:/Users/MimsLab/Documents/Ye/merged estuary/Merged_estuaries.shp", layer="merged_estuaries")
est <- st_transform(estuary, 4326)
#estbuf <- st_buffer(est, units::set_units(0.00898, degree)) #1 degree=111325m, 0.00898=1000m buffer, 0.00449=500m buffer, 0.0022457=250m buffer, 0.001797=200mbuffer, 0.001347=150m buffer, 0.000449=50m buffer, 0.000898 gives buffer of decimal degrees equal to 100m
ests <- as(est, "Spatial")
estsp <- as(ests, "SpatialPolygons")

estsp <- spTransform(estsp, CRS="+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84")
proj4string(estsp) <- CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84")


ext = NULL # create empty list/frame


for(i in 1:length(FILES_NEW)){
  
  datfile <- read.delim(FILES_NEW[i], na.strings = c("NA", " ", ""), sep=",") #read in the delimited files

  datfile1 <- datfile[!is.na(datfile$decimallatitude),] #delete rows with missing latitude
  datfile2 <- datfile1[!is.na(datfile1$decimallongitude),] #delete rows with missing longitude
  datfile3 <- datfile2[!is.na(datfile2$year),] #delete rows with missing year
  
  #find issue and delete those rows
  df1 <- datfile3[!grepl("COUNTRY_COORDINATE_MISMATCH", datfile3$issue),]#COUNTRY_COORDINATE_MISMATCH
  df2 <- df1[!grepl("IDENTIFIED_DATE_UNLIKELY", df1$issue),]#IDENTIFIED_DATE_UNLIKELY
  df3 <- df2[!grepl("RECORDED_DATE_MISMATCH", df2$issue),]#RECORDED_DATE_MISMATCH
  df4 <- df3[!grepl("ZERO_COORDINATE", df3$issue),]#ZERO_COORDINATE
  df5 <- df4[!is.na(df4$gbifid),]#delete all NA values in gbifid column
  df6 <- df5[!is.na(df5$countrycode),]#delete all NA values in countrycode column
  df7 <- df6[grepl("US", df6$countrycode),] #returns only US entries

  SpeciesName <- as.character(df1$species[2]) #species name for file name
  USentries <- sum(df1$countrycode=="US") ## of US entries
  ext <- rbind(ext, data.frame(SpeciesName, USentries)) #combines data frame with previous data frame
  write.csv(df7, file = paste0("C:/Users/MimsLab/Documents/Ye/semi_cleaned/", SpeciesName, ".csv"), row.names=FALSE) #output the file as csv
  

}

FILES_SHP <- list.files(path="C:/Users/MimsLab/Documents/Ye/shape files 4_17_2018", pattern = "\\.shp$")#create file list for loop

for (i in 1:length(FILES_SHP)){ #loop
  
  
  #downloads estuary shapefiles and combines them
  #*change to loop through maps*
  maps <- st_read(paste("C:/Users/MimsLab/Documents/Ye/shape files 4_17_2018/",FILES_SHP[i],sep=""), layer=substr(FILES_SHP[i], 1, nchar(FILES_SHP[i])-4))
  
  map1 <- st_transform(maps, 4326)
  map2 <- as(map1, "Spatial")
  map3 <- as(map2, "SpatialPolygons")
  
  map3 <- spTransform(map3, CRS="+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84")
  proj4string(map3) <- CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84 +datum=WGS84")
  
  
  
  
  #uploads csv, converts to SpatialPointsDataFrame for subsetting points to lower 48
  setwd("C:/Users/MimsLab/Documents/Ye/semi_cleaned/")
  
  dat.name <- substr(FILES_SHP[i], 1, nchar(FILES_SHP[i])-4)
  dat.name2 <- strsplit(dat.name, "[_]")
  dat.name3 <- sapply(dat.name2, paste, collapse =" ")
  dat <- read.csv(paste(dat.name3,".csv", sep=""), header=TRUE)
  elim <- dat[grep("Estuary",dat$locality),] #subsets those records with Estuary in column "locality"
  noest <- dat[!dat$gbifid %in% elim$gbifid,] #eliminates those records with Estuary in column "locality"
  datf <- data.frame(dat$decimallongitude, dat$decimallatitude, dat$year)
  datfsp <- SpatialPointsDataFrame(datf, dat, proj4string = CRS("+init=epsg:4326 +proj=longlat +ellps=WGS84
                                                                +datum=WGS84"))
  pts_subset <- datfsp[USAsp,]#subsets occurrence points to those of mainland lower 48 from http://robinlovelace.net/r/2014/07/29/clipping-with-r.html
  pointsUS <- as.data.frame(datfsp)#changes spatial points to a dataframe for mapping with ggplot2
  
  #subset estuarine records
  subsetpt <- pts_subset[estsp,]#subsets occurrence points to those of estuary
  pointsest <- as.data.frame(subsetpt)#changes spatial points to a dataframe for mapping with ggplot2
  final <- pointsUS[pointsUS$gbifid %in% pointsest$gbifid,] #takes out occurrence records in estuaries
  
  #cleans up extra columns in dataframe and writes file with subsetted records
  final$noest.decimallatitude <- NULL
  final$noest.decimallongitude <- NULL
  final$noest.year <- NULL
  
  SpeciesName <- as.character(final[2,10]) #get species name for title of plot
  write.csv(final, file=paste0("C:/Users/MimsLab/Documents/Ye/Final location data/", dat.name3, ".csv"), row.names = FALSE)
  
}

